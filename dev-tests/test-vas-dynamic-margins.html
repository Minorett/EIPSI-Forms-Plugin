<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAS Dynamic Margins Formula - Testing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .formula-results {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .observed-values {
            background: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .match { color: #2e7d32; font-weight: bold; }
        .close { color: #f57c00; font-weight: bold; }
        .nomatch { color: #d32f2f; font-weight: bold; }
        .vas-slider {
            position: relative;
            height: 60px;
            margin: 40px 0;
            background: linear-gradient(to right, #e3f2fd, #bbdefb);
            border-radius: 5px;
        }
        .vas-track {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            transform: translateY(-50%);
        }
        .vas-label {
            position: absolute;
            top: 20px;
            transform: translateX(-50%);
            font-size: 16px;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            white-space: nowrap;
            max-width: 22%;
            text-align: center;
            word-break: break-word;
        }
        .vas-label.first {
            text-align: left;
            transform: translateX(-100%);
        }
        .vas-label.last {
            text-align: right;
            transform: translateX(50%);
        }
    </style>
</head>
<body>
    <h1>VAS Dynamic Margins Formula - Validación</h1>
    <p>Esta página valida la nueva fórmula de márgenes dinámicos implementada:</p>
    <pre>minMargin = (3 + (1 - ratio) * 110) * (fontSize / 16)</pre>

    <div class="test-container">
        <h2>Test Cases Validados</h2>
        <div id="results"></div>
    </div>

    <div class="test-container">
        <h2>VAS Visual Test</h2>
        <p>Labels: "Muy mal; Mal; Más o menos; Bien; Muy bien"</p>
        <p>Font Size: 16px</p>
        
        <div class="vas-slider">
            <div class="vas-track"></div>
            <div id="visual-test"></div>
        </div>
        
        <div style="margin-top: 20px;">
            <label>Alignment Display (0-100): </label>
            <input type="range" id="alignment-slider" min="0" max="100" value="100">
            <span id="alignment-value">100</span>
        </div>
    </div>

    <script>
        // Implementación de la fórmula de márgenes dinámicos
        const VAS_ALIGNMENT_INTERNAL_MAX = 80;

        function sanitizeAlignmentInternal(value, fallback = 40) {
            if (typeof value !== 'number' || Number.isNaN(value)) {
                return fallback;
            }

            let nextValue = value;

            // Si viene de formatos antiguos (0–100), lo convertimos al rango interno 0–80.
            if (nextValue > VAS_ALIGNMENT_INTERNAL_MAX) {
                nextValue = (nextValue / 100) * VAS_ALIGNMENT_INTERNAL_MAX;
            }

            return Math.min(Math.max(nextValue, 0), VAS_ALIGNMENT_INTERNAL_MAX);
        }

        function getAlignmentRatio(internal) {
            const safeInternal = sanitizeAlignmentInternal(internal);
            return safeInternal / VAS_ALIGNMENT_INTERNAL_MAX;
        }

        function calculateLabelPositionPercent(index, total, ratio) {
            if (total <= 1) {
                return 50;
            }

            const safeRatio = Math.min(Math.max(ratio, 0), 1);
            const base = (index / (total - 1)) * 100;

            // Escala desde el centro: 0 → todo al 50%, 1 → distribución original
            return 50 + (base - 50) * safeRatio;
        }

        function calculateLabelPositionStyle({index, totalLabels, alignmentInternal, labelFontSize = 16}) {
            const ratio = getAlignmentRatio(alignmentInternal);
            const isFirst = index === 0;
            const isLast = totalLabels > 0 && index === totalLabels - 1;

            // FACTOR 1: Font size adjustment
            const fontSizeFactor = Math.max(1, labelFontSize / 16);

            // FACTOR 2: Alignment compression
            const alignmentCompression = 1 - ratio;  // 0 a 1
            const minMargin = (3 + alignmentCompression * 110) * fontSizeFactor;

            // Clampear a máximo razonable (40%)
            const clampedMinMargin = Math.min(minMargin, 40);
            const maxMargin = 100 - clampedMinMargin;

            // Calcular posición base
            let positionPercent = calculateLabelPositionPercent(
                index,
                totalLabels,
                ratio
            );

            // Clamping para first y last
            if (isFirst) {
                positionPercent = Math.max(positionPercent, clampedMinMargin);
            }
            if (isLast) {
                positionPercent = Math.min(positionPercent, maxMargin);
            }

            return {
                left: positionPercent,
                isFirst,
                isLast
            };
        }

        // Casos observados del ticket
        const testCases = [
            {
                name: "Alignment 100",
                displayValue: 100,
                expectedMargin: 3,
                labelSize: 16
            },
            {
                name: "Alignment 79",
                displayValue: 79,
                expectedMargin: 10.625,
                labelSize: 16
            },
            {
                name: "Alignment 73",
                displayValue: 73,
                expectedMargin: 13.75,
                labelSize: 16
            },
            {
                name: "Alignment 70",
                displayValue: 70,
                expectedMargin: 15,
                labelSize: 16
            }
        ];

        // Función para validar resultados
        function validateFormula(testCase) {
            const internalValue = (testCase.displayValue / 100) * VAS_ALIGNMENT_INTERNAL_MAX;
            const ratio = getAlignmentRatio(internalValue);
            const fontSizeFactor = Math.max(1, testCase.labelSize / 16);
            const alignmentCompression = 1 - ratio;
            const calculatedMargin = (3 + alignmentCompression * 110) * fontSizeFactor;
            
            return {
                internalValue,
                ratio,
                calculatedMargin: Math.round(calculatedMargin * 100) / 100,
                difference: Math.abs(calculatedMargin - testCase.expectedMargin)
            };
        }

        // Mostrar resultados
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            let html = '';

            testCases.forEach(testCase => {
                const validation = validateFormula(testCase);
                const difference = validation.difference;
                let statusClass, statusText;
                
                if (difference < 2) {
                    statusClass = 'match';
                    statusText = '✅ MATCH';
                } else if (difference < 5) {
                    statusClass = 'close';
                    statusText = '⚠️ CERCANO';
                } else {
                    statusClass = 'nomatch';
                    statusText = '❌ NO ENCAJA';
                }

                html += `
                    <div class="formula-results">
                        <h3>${testCase.name} (Label Size: ${testCase.labelSize}px)</h3>
                        <p><strong>Display:</strong> ${testCase.displayValue} → <strong>Internal:</strong> ${validation.internalValue.toFixed(1)}</p>
                        <p><strong>Ratio:</strong> ${validation.ratio.toFixed(4)}</p>
                        <p><strong>Calculado:</strong> ${validation.calculatedMargin}%</p>
                        <p><strong>Observado:</strong> ${testCase.expectedMargin}%</p>
                        <p><strong>Diferencia:</strong> ${difference.toFixed(2)}% <span class="${statusClass}">${statusText}</span></p>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Visual test
        function updateVisualTest(alignmentDisplay = 100) {
            const labels = ["Muy mal", "Mal", "Más o menos", "Bien", "Muy bien"];
            const totalLabels = labels.length;
            const internalValue = (alignmentDisplay / 100) * VAS_ALIGNMENT_INTERNAL_MAX;
            const visualDiv = document.getElementById('visual-test');
            
            let html = '';
            
            labels.forEach((label, index) => {
                const position = calculateLabelPositionStyle({
                    index,
                    totalLabels,
                    alignmentInternal: internalValue,
                    labelFontSize: 16
                });
                
                const className = position.isFirst ? 'vas-label first' : 
                                position.isLast ? 'vas-label last' : 'vas-label';
                
                html += `<div class="${className}" style="left: ${position.left}%">${label}</div>`;
            });
            
            visualDiv.innerHTML = html;
            document.getElementById('alignment-value').textContent = alignmentDisplay;
        }

        // Event listeners
        document.getElementById('alignment-slider').addEventListener('input', function() {
            updateVisualTest(parseInt(this.value));
        });

        // Inicializar
        displayResults();
        updateVisualTest(100);
    </script>
</body>
</html>
